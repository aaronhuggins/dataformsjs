"use strict";function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var React;function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(r){var n=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(r);return _possibleConstructorReturn(this,n?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}void 0===window.exports&&(window.exports=window),void 0===window.React&&void 0!==window.preact&&(React=window.preact),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var jsonDataCache=[],graphQL_Cache={};function saveDataToCache(t,e,r,n){for(var o=0,a=jsonDataCache.length;o<a;o++){var i=jsonDataCache[o];if(i.url===t&&i.query===e)return i.params=JSON.stringify(r),void(i.data=n)}jsonDataCache.push({url:t,query:e,params:JSON.stringify(r),data:n})}function getDataFromCache(t,e,r){for(var n=0,o=jsonDataCache.length;n<o;n++){var a=jsonDataCache[n];if(a.url===t&&a.query===e){if(JSON.stringify(r)===a.params)return a.data;break}}return null}function IsLoading(t){return 0===t.fetchState&&t.children?t.children:null}function HasError(t){if(!(-1===t.fetchState)||!t.children)return null;var e=t.error;return"string"==typeof e&&-1===e.indexOf("Error")&&(e="Error - "+e),React.cloneElement(t.children,{error:e})}function IsLoaded(t){return 1===t.fetchState&&t.children?React.cloneElement(t.children,{data:t.data,params:t.params,handleChange:t.handleChange}):null}var JsonData=function(){_inherits(n,React.Component);var r=_createSuper(n);function n(t){var e;return _classCallCheck(this,n),(e=r.call(this,t))._isFetching=!1,e._isMounted=!1,e.fetchData=e.fetchData.bind(_assertThisInitialized(e)),e.handleChange=e.handleChange.bind(_assertThisInitialized(e)),e._querySrc=t&&t.querySrc?t.querySrc:void 0,e._query=t&&t.query?t.query:void 0,e.state={fetchState:0,error:null,params:e.getUrlParams(),data:null},e}return _createClass(n,[{key:"getUrlParams",value:function(){var t,e={};if(this.props&&!0===this.props.graphQL)return void 0===this.props.variables?{}:this.props.variables;for(t in this.props)"url"!==t&&"string"==typeof this.props[t]&&(e[t]=this.props[t]);return e}},{key:"componentDidMount",value:function(){if((this._isMounted=!0)===this.props.graphQL&&void 0===this._query&&void 0!==this._querySrc&&void 0!==graphQL_Cache[this._querySrc]&&(this._query=graphQL_Cache[this._querySrc]),this.props.loadOnlyOnce){var t=getDataFromCache(this.props.url,this._query,this.getUrlParams());if(null!==t)return void this.setState({fetchState:1,data:t})}var e,r;!0!==this.props.graphQL||void 0!==this._query||void 0===this._querySrc?this.fetchData():(e=this._querySrc,r=this,fetch(e,null).then(function(t){var e=t.status;if(200<=e&&e<300||304===e)return Promise.resolve(t);t="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(t)}).then(function(t){return t.text()}).then(function(t){graphQL_Cache[e]=t,r._query=graphQL_Cache[e],r.fetchData()}).catch(function(t){throw new Error("Error Downloading GraphQL Script: ["+e+"], Error: "+t.toString())}))}},{key:"componentDidUpdate",value:function(t,e){(!0===this.props.graphQL?JSON.stringify(t.variables)!==JSON.stringify(this.props.variables):this.buildUrl(e.params)!==this.buildUrl(this.props))&&this.setState({params:this.getUrlParams()},this.fetchData)}},{key:"componentWillUnmount",value:function(){this._isMounted=!1}},{key:"buildUrl",value:function(t){var e=this.props.url;if(!0!==this.props.graphQL&&0<Object.keys(t).length)for(var r in t)-1<e.indexOf(":"+r)&&(e=e.replace(new RegExp(":"+r,"g"),encodeURIComponent(t[r])));return e}},{key:"fetchData",value:function(){var t,e,n=this,r=this.buildUrl(this.state.params);this._isFetching||(this._isFetching=!0,t={mode:"cors",cache:"no-store",credentials:"same-origin"},this.props.fetchOptions&&(t=this.props.fetchOptions),this.props.fetchHeaders&&(t.headers=this.props.fetchHeaders),!0===this.props.graphQL&&(e=void 0===this.props.variables?{}:this.props.variables,"file://"===window.location.origin||"null"===window.location.origin?(r+=-1===r.indexOf("?")?"?":"&",r+="query="+encodeURIComponent(this._query.trim()),r+="&variables="+encodeURIComponent(JSON.stringify(e))):(t.method="POST",void 0===t.headers?t.headers={"Content-Type":"application/json"}:t.headers["Content-Type"]="application/json",t.body=JSON.stringify({query:this._query,variables:e}))),this.setState({fetchState:0},function(){n.updateView(),fetch(r,t).then(function(t){var e=t.status;if(200<=e&&e<300||304===e)return Promise.resolve(t);t="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(t)}).then(function(t){return t.json()}).then(function(t){var e,r=!0===n.props.graphQL;if(r&&(t.errors&&t.errors.length))throw e=1===t.errors.length&&t.errors[0].message?"[GraphQL Error]: "+t.errors[0].message:("string"==typeof n.props.errorTextGraphQLErrors?n.props.errorTextGraphQLErrors:"{count} GraphQL Errors occured. See console for full details.").replace("{count}",t.errors.length),console.error(t.errors),e;n._isMounted&&n.setState({fetchState:1,data:r?t.data:t}),n.props.loadOnlyOnce&&saveDataToCache(n.props.url,n._query,n.getUrlParams(),r?t.data:t)}).catch(function(t){n._isMounted&&n.setState({fetchState:-1,error:t.toString()})}).finally(function(){n._isFetching=!1,n.updateView()})}))}},{key:"handleChange",value:function(t){t=0<arguments.length&&void 0!==t?t:null;this._isMounted&&this.setState({data:null===t?this.state.data:t})}},{key:"updateView",value:function(){if("function"==typeof this.props.onViewUpdated)try{this.props.onViewUpdated()}catch(t){console.error(t)}}},{key:"render",value:function(){return React.createElement(React.Fragment,null,React.createElement(IsLoading,{fetchState:this.state.fetchState},this.props.isLoading),React.createElement(HasError,{fetchState:this.state.fetchState,error:this.state.error},this.props.hasError),React.createElement(IsLoaded,{fetchState:this.state.fetchState,data:this.state.data,params:this.state.params,handleChange:this.handleChange},this.props.isLoaded))}}]),n}();exports.default=JsonData;