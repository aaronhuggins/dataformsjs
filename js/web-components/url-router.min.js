// @link https://www.dataformsjs.com
// @version 4.8.0
// @author Conrad Sollitt (https://conradsollitt.com)
// @license MIT
import{showError,componentsAreDefined,usingWebComponentsPolyfill}from"./utils.min.js";import{shadowTmpl,setupRouting,downloadTemplate,setView,routeMatches,showFatalError,lazyLoadScripts}from"./utils-router.js";class UrlRouter extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this.currentRoute=null,this.updateView=this.updateView.bind(this),this.useHistoryMode="history"===this.getAttribute("mode"),this.updateView()}connectedCallback(){const t=this.useHistoryMode?"popstate":"hashchange";window.addEventListener(t,this.updateView)}disconnectedCallback(){const t=this.useHistoryMode?"popstate":"hashchange";window.removeEventListener(t,this.updateView)}async updateView(){await componentsAreDefined(this,"url-route"),this.currentRoute=null;const t=setupRouting(this);let e=this.useHistoryMode?window.location.pathname:window.location.hash.substr(1);""===e&&(e="/");const o=this.querySelectorAll("url-route");let r=null;for(const s of o){if(null===s.path)return showFatalError(this,"Error, element <url-route> is missing attribute [path]"),void console.log(s);const o=routeMatches(e,s.path);if(o.isMatch){const r=s.redirect;if(null!==r&&r!==e)return void(this.useHistoryMode?(window.history.pushState(null,null,s.redirect),this.updateView()):window.location.hash="#"+r);await lazyLoadScripts(s);const i=s.template;return this.currentRoute=s,void(null===i?downloadTemplate(this,t,s,o.urlParams):setView(this,t,i,o.urlParams))}s.isDefault&&(r=s)}if(r){const t=r.path;if(""!==t&&-1===t.indexOf(":"))return void(this.useHistoryMode?(window.history.pushState(null,null,t),this.updateView()):window.location.hash="#"+r.path)}showError(t,`Error - The route [${e}] does not have a matching <url-route> element and no default route is defined using [default-route].`)}}class UrlRoute extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0))}get path(){return this.getAttribute("path")}get src(){return this.getAttribute("src")}get redirect(){return this.getAttribute("redirect")}get isDefault(){return null!==this.getAttribute("default-route")}get template(){const t=this.querySelector("template");return null===t?null:t.innerHTML}set template(t){let e=this.querySelector("template");null===e&&(e=document.createElement("template"),this.appendChild(e)),e.innerHTML=t}}window.customElements.define("url-router",UrlRouter),window.customElements.define("url-route",UrlRoute);