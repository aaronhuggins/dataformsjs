// @link https://www.dataformsjs.com
// @version 4.8.0
// @author Conrad Sollitt (https://conradsollitt.com)
// @license MIT
import{render,setElementText,bindAttrTmpl,showError,componentsAreDefined,polyfillCustomElements,usingWebComponentsPolyfill}from"./utils.min.js";const appEvents={routeChanged:"app:routeChanged",error:"app:error"},shadowTmpl=document.createElement("template");function downloadTemplate(t,e,r,o){const s=r.src;if(null===s||""===s){const s=`Missing <template> or [src] attribute for route <${r.tagName.toLowerCase()} path="${r.path}">.`;return showError(e,s),t.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:s})),void t.dispatchEvent(new CustomEvent(appEvents.routeChanged,{bubbles:!0,detail:{url:t._currentRoute.path,urlParams:o}}))}fetch(s,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const r="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(r)}}).then(t=>t.text()).then(s=>{r.template=s,setView(t,e,s,o)}).catch(o=>{const n=render`Error with <${r.tagName.toLowerCase()} path="${r.path}"> - Error Downloading Template: [${s}], Error: ${o}`;showError(e,n),t.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:n}))})}function setView(t,e,r,o){e.innerHTML=r;let s=e.querySelectorAll("[url-params]");const n=JSON.stringify(o);for(const t of s)t.setAttribute("url-params",n);s=e.querySelectorAll("[url-param]");for(const t of s){const e=t.getAttribute("url-param"),r=void 0===o[e]?"":o[e];setElementText(t,r)}s=e.querySelectorAll("[url-attr-param]");for(const t of s)bindAttrTmpl(t,"url-attr-param",o);polyfillCustomElements(),t.dispatchEvent(new CustomEvent(appEvents.routeChanged,{bubbles:!0,detail:{url:t._currentRoute.path,urlParams:o}}))}shadowTmpl.innerHTML="\n    <style>:host { display:none; }</style>\n    <slot></slot>\n";class UrlHashRouter extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this._currentRoute=null,this.updateView=this.updateView.bind(this),this.updateView()}connectedCallback(){window.addEventListener("hashchange",this.updateView)}disconnectedCallback(){window.removeEventListener("hashchange",this.updateView)}get currentRoute(){return this._currentRoute}async updateView(){await componentsAreDefined(this,"url-hash-route"),this._currentRoute=null;const t=this.getAttribute("view-selector");if(null===t||""===t)return void this.showFatalError("Error, element <url-hash-router> is missing attribute [view-selector]");const e=document.querySelector(t);if(null===e)return void this.showFatalError(render`Error, element from <url-hash-router view-selector="${t}"> was not found on the page.`);let r=window.location.hash;0===r.indexOf("#")&&(r=r.substr(1)),""===r&&(r="/");const o=this.querySelectorAll("url-hash-route");let s=null;for(const t of o){if(null===t.path)return this.showFatalError("Error, element <url-hash-route> is missing attribute [path]"),void console.log(t);const o=this.routeMatches(r,t.path);if(o.isMatch){const r=t.redirect;if(null!==r)return void(window.location.hash="#"+r);const s=t.template;return this._currentRoute=t,void(null===s?downloadTemplate(this,e,t,o.urlParams):setView(this,e,s,o.urlParams))}t.isDefault&&(s=t)}if(s){const t=s.path;if(""!==t&&-1===t.indexOf(":"))return void(window.location.hash="#"+s.path)}showError(e,`Error - The route [${r}] does not have a matching <url-hash-route> element and no default route is defined using [default-route].`)}routeMatches(t,e){const r=t.split("/"),o=e.split("/"),s=r.length,n={};if(s!==o.length)return{isMatch:!1};for(let t=0;t<s;t++){const e=decodeURIComponent(r[t]);if(e!==o[t]){if(":"!==o[t].substr(0,1))return{isMatch:!1};n[o[t].substr(1)]=e}}return{isMatch:!0,urlParams:n}}showFatalError(t){this.style.display="block",this.style.padding="1em",this.style.backgroundColor="red",this.style.color="white",this.style.fontSize="1.5em",this.textContent=t,this.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:t})),this.dispatchEvent(new CustomEvent(appEvents.routeChanged,{bubbles:!0,detail:{url:null,urlParams:null}})),console.error(t)}}class UrlHashRoute extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0))}get path(){return this.getAttribute("path")}get src(){return this.getAttribute("src")}get redirect(){return this.getAttribute("redirect")}get isDefault(){return null!==this.getAttribute("default-route")}get template(){const t=this.querySelector("template");return null===t?null:t.innerHTML}set template(t){let e=this.querySelector("template");null===e&&(e=document.createElement("template"),this.appendChild(e)),e.innerHTML=t}}window.customElements.define("url-hash-router",UrlHashRouter),window.customElements.define("url-hash-route",UrlHashRoute);