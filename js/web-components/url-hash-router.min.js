// @link https://www.dataformsjs.com
// @version 4.8.0
// @author Conrad Sollitt (https://conradsollitt.com)
// @license MIT
import{render,setElementText,bindAttrTmpl,showError,componentsAreDefined,polyfillCustomElements,usingWebComponentsPolyfill}from"./utils.min.js";const shadowTmpl=document.createElement("template");function downloadTemplate(t,e,r,n){const o=r.src;if(null===o||""===o)return showError(e,`Missing <template> or [src] attribute for route [${r.path}].`),void t.dispatchEvent(new Event("contentLoaded"));fetch(o,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const r="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(r)}}).then(t=>t.text()).then(o=>{r.template=o,setView(t,e,o,n)}).catch(r=>{showError(e,r),t.dispatchEvent(new Event("contentLoaded"))})}function setView(t,e,r,n){e.innerHTML=r;let o=e.querySelectorAll("[url-params]");const s=JSON.stringify(n);for(const t of o)t.setAttribute("url-params",s);o=e.querySelectorAll("[url-param]");for(const t of o){const e=t.getAttribute("url-param"),r=void 0===n[e]?"":n[e];setElementText(t,r)}o=e.querySelectorAll("[url-attr-param]");for(const t of o)bindAttrTmpl(t,"url-attr-param",n);polyfillCustomElements(),t.dispatchEvent(new Event("contentLoaded"))}shadowTmpl.innerHTML="\n    <style>:host { display:none; }</style>\n    <slot></slot>\n";class UrlHashRouter extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this._currentRoute=null,this.updateView=this.updateView.bind(this),this.updateView()}connectedCallback(){window.addEventListener("hashchange",this.updateView)}disconnectedCallback(){window.removeEventListener("hashchange",this.updateView)}get currentRoute(){return this._currentRoute}async updateView(){await componentsAreDefined(this,"url-hash-route"),this._currentRoute=null;const t=this.getAttribute("view-selector");if(null===t||""===t)return void this.showFatalError("Error, element <url-hash-router> is missing attribute [view-selector]");const e=document.querySelector(t);if(null===e)return void this.showFatalError(render`Error, element from <url-hash-router view-selector="${t}"> was not found on the page.`);let r=window.location.hash;0===r.indexOf("#")&&(r=r.substr(1)),""===r&&(r="/");const n=this.querySelectorAll("url-hash-route");let o=null;for(const t of n){if(null===t.path)return this.showFatalError("Error, element <url-hash-route> is missing attribute [path]"),void console.log(t);const n=this.routeMatches(r,t.path);if(n.isMatch){const r=t.redirect;if(null!==r)return void(window.location.hash="#"+r);const o=t.template;return this._currentRoute=t,void(null===o?downloadTemplate(this,e,t,n.urlParams):setView(this,e,o,n.urlParams))}t.isDefault&&(o=t)}if(o){const t=o.path;if(""!==t&&-1===t.indexOf(":"))return void(window.location.hash="#"+o.path)}showError(e,`Error - The route [${r}] does not have a matching <url-hash-route> element and no default route is defined using [default-route].`)}routeMatches(t,e){const r=t.split("/"),n=e.split("/"),o=r.length,s={};if(o!==n.length)return{isMatch:!1};for(let t=0;t<o;t++){const e=decodeURIComponent(r[t]);if(e!==n[t]){if(":"!==n[t].substr(0,1))return{isMatch:!1};s[n[t].substr(1)]=e}}return{isMatch:!0,urlParams:s}}showFatalError(t){this.style.display="block",this.style.padding="1em",this.style.backgroundColor="red",this.style.color="white",this.style.fontSize="1.5em",this.textContent=t,this.dispatchEvent(new Event("error")),this.dispatchEvent(new Event("contentLoaded")),console.error(t)}}class UrlHashRoute extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0))}get path(){return this.getAttribute("path")}get src(){return this.getAttribute("src")}get redirect(){return this.getAttribute("redirect")}get isDefault(){return null!==this.getAttribute("default-route")}get template(){const t=this.querySelector("template");return null===t?null:t.innerHTML}set template(t){let e=this.querySelector("template");null===e&&(e=document.createElement("template"),this.appendChild(e)),e.innerHTML=t}}window.customElements.define("url-hash-router",UrlHashRouter),window.customElements.define("url-hash-route",UrlHashRoute);