import{render,setElementText,bindAttrTmpl,showError,polyfillCustomElements,showErrorAlert}from"./utils.min.js";const appEvents={routeChanged:"app:routeChanged",error:"app:error"};function dispatchRouteChanged(e,t,r){void 0!==r&&e.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:r}));const o=null!==e.currentRoute,n={url:o?e.currentRoute.path:null,urlParams:t};if(e.dispatchEvent(new CustomEvent(appEvents.routeChanged,{bubbles:!0,detail:n})),!o)return;const s=e.currentRoute.getAttribute("onload");if(s)try{const t=new Function("return "+s)();"function"==typeof t&&t()}catch(t){showErrorAlert(`Error from function <${e.tagName.toLowerCase()} onload="${s}">: ${t.message}`),console.error(t)}}export const shadowTmpl=document.createElement("template");shadowTmpl.innerHTML="\n    <style>:host { display:none; }</style>\n    <slot></slot>\n";export function setupRouting(e){const t=e.getAttribute("view-selector");if(null===t||""===t)return void showFatalError(e,`Error, element <${e.tagName.toLowerCase()}> is missing attribute [view-selector]`);const r=document.querySelector(t);if(null===r)return void showFatalError(e,render`Error, element from <${e.tagName.toLowerCase()} view-selector="${t}"> was not found on the page.`);const o=e.getAttribute("loading-template-selector");if(o){const t=document.querySelector(o);t&&("TEMPLATE"===t.tagName?r.innerHTML=t.innerHTML:console.warn(`Unable to show loading screen from <${e.tagName.toLowerCase()} loading-template-selector="${o}">. Only <template> tags are allowed.`))}return r};export function downloadTemplate(e,t,r,o){const n=r.src;if(null===n||""===n){const n=`Missing <template> or [src] attribute for route <${r.tagName.toLowerCase()} path="${r.path}">.`;return showError(t,n),void dispatchRouteChanged(e,o,n)}fetch(n,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(e=>{const t=e.status;if(t>=200&&t<300||304===t)return Promise.resolve(e);{const r="Error loading data. Server Response Code: "+t+", Response Text: "+e.statusText;return Promise.reject(r)}}).then(e=>e.text()).then(n=>{r.template=n,setView(e,t,n,o)}).catch(o=>{const s=render`Error with <${r.tagName.toLowerCase()} path="${r.path}"> - Error Downloading Template: [${n}], Error: ${o}`;showError(t,s),e.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:s}))})};export function setView(e,t,r,o){t.innerHTML=r;let n=t.querySelectorAll("[url-params]");const s=JSON.stringify(o);for(const e of n)e.setAttribute("url-params",s);n=t.querySelectorAll("[url-param]");for(const e of n){const t=e.getAttribute("url-param"),r=void 0===o[t]?"":o[t];setElementText(e,r)}n=t.querySelectorAll("[url-attr-param]");for(const e of n)bindAttrTmpl(e,"url-attr-param",o);if(polyfillCustomElements(),"url-router"===e.tagName.toLowerCase()){const t=document.querySelectorAll('a[href^="/"]:not([data-no-pushstate])');for(const r of t)r.addEventListener("click",t=>{if(!0!==t.ctrlKey)return t.preventDefault(),t.stopPropagation(),t.currentTarget.href?(window.history.pushState(null,null,t.currentTarget.href),e.updateView()):showErrorAlert("Error, link click does not work because href is missing."),!1})}dispatchRouteChanged(e,o)};export function routeMatches(e,t){const r=e.split("/"),o=t.split("/"),n=r.length,s={};if(n!==o.length)return{isMatch:!1};for(let e=0;e<n;e++){const t=decodeURIComponent(r[e]);if(t!==o[e]){if(":"!==o[e].substr(0,1))return{isMatch:!1};s[o[e].substr(1)]=t}}return{isMatch:!0,urlParams:s}};export function showFatalError(e,t){e.style.display="block",e.style.padding="1em",e.style.backgroundColor="red",e.style.color="white",e.style.fontSize="1.5em",e.textContent=t,dispatchRouteChanged(e,null,t),console.error(t)};export async function lazyLoadScripts(e){const t=e.getAttribute("lazy-load"),r=[];if(t){t.split(",").map(e=>e.trim()).forEach(function(e){void 0!==window.lazyLoad&&void 0!==window.lazyLoad[e]||showErrorAlert("Missing [window.lazyLoad] scripts for: "+e),r.push(loadScripts(window.lazyLoad[e]))})}await Promise.all(r)};export function loadScripts(e){if(!Array.isArray(e)){if(!("string"==typeof e||e instanceof Object&&("module"in e||"nomodule"in e)))return showErrorAlert("Invalid Script for [loadScripts()] or [window.lazyLoad], expected string, an array of strings, or a valid object. Check console."),console.warn("window.loadScripts():"),console.warn(e),new Promise(function(e){e()});e=[e]}return new Promise(function(t){let r=0;const o=e.length;!function n(){if(r===o)return void t();let s=e[r],l=!1;if(s instanceof Object){if(void 0===s.module)return void t();l=!0,s=s.module}r++,s.endsWith(".js")?function(e,t){return new Promise(function(r){const o=document.querySelectorAll("script");for(let t=0,n=o.length;t<n;t++)if(o[t].getAttribute("src")===e)return void r();const n=document.createElement("script");n.onload=r,n.onerror=(()=>{showErrorAlert("Error loading JS File: "+e),r()}),t&&n.setAttribute("type","module"),n.src=e,document.head.appendChild(n)})}(s,l).then(n):s.endsWith(".css")?function(e){return new Promise(function(t){const r=document.querySelectorAll("link");for(let o=0,n=r.length;o<n;o++)if("stylesheet"===r[o].rel&&r[o].getAttribute("href")===e)return void t();const o=document.createElement("link");o.rel="stylesheet",o.onload=t,o.onerror=(()=>{showErrorAlert("Error loading CSS File: "+e),t()}),o.href=e,document.head.appendChild(o)})}(s).then(n):(showErrorAlert("Invalid Script for [loadScripts()] or [window.lazyLoad]: "+s),n())}()})};