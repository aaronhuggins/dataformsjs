import{WebComponentService}from"./WebComponentService.min.js";import{showErrorAlert,setElementText}from"./utils.min.js";class I18nService extends WebComponentService{constructor(){function t(t,e,n=null){const i=t.getAttribute(e);return i||n}super(),this.fileName=t(this,"file","_"),this.fileDir=t(this,"file-dir","i18n"),this.defaultLocale=t(this,"default-locale"),this.supportedLocales=t(this,"locales","").split(",").map(t=>t.trim()),this.currentLocale=null,this.langText={},this.langCache={},this._isRunning=!1,window.i18nText=this.getText.bind(this);const e=document.querySelector("url-router");this.hashRouting=null===e||!0!==e.useHistoryMode}getUserDefaultLang(){if(navigator.languages&&navigator.languages.length&&this.supportedLocales&&this.supportedLocales.length)for(let t=0,e=navigator.languages.length;t<e;t++)if(-1!==this.supportedLocales.indexOf(navigator.languages[t]))return navigator.languages[t];return this.defaultLocale}validateSettings(){return null===this.defaultLocale?(console.warn("Using <i18n-service> without [default-locale] being filled in."),!1):0!==this.supportedLocales.length||(console.warn("Using <i18n-service> without [locales] being filled in."),!1)}load(){if(this._isRunning)return;this._isRunning=!0;const t=this.validateSettings(),e=document.querySelector("url-router");if(this.currentLocale=null,this.hashRouting?t&&0===window.location.hash.indexOf("#/")&&(this.currentLocale=window.location.hash.split("/")[1]):t&&window.location.pathname.split("/").length>1&&(this.currentLocale=window.location.pathname.split("/")[1]),null!==this.currentLocale&&(""!==this.currentLocale&&-1!==this.supportedLocales.indexOf(this.currentLocale)||(this.currentLocale=null)),window.i18n_Locale=this.currentLocale,null===this.currentLocale)return void(this._isRunning=!1);document.documentElement.lang=this.currentLocale;const n=this.fileDir+"/"+this.fileName+"."+this.currentLocale+".json",i=[this.downloadFile(n)],l=e&&e.currentRoute?e.currentRoute.getAttribute("data-i18n-file"):null;let o=null;l&&(o=this.fileDir+"/"+l+"."+this.currentLocale+".json",i.push(this.downloadFile(o))),Promise.all(i).finally(()=>{this.langText=o?Object.assign({},this.langCache[n],this.langCache[o]):this.langCache[n],this.updateElements(),this._isRunning=!1})}getText(t){return this.langText&&this.langText[t]?this.langText[t]:t}downloadFile(t){return void 0!==this.langCache[t]?new Promise(t=>{t()}):fetch(t,{cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const n=`Error loading data. Server Response Code: ${e}, Response Text: ${t.statusText}`;return Promise.reject(n)}}).then(t=>t.json()).then(e=>{this.langCache[t]=e}).catch(e=>{showErrorAlert(`Error Downloading I18N file: [${t}], Response Code Status: ${e.message}`),this.langCache[t]={}})}updateElements(){let t=document.querySelectorAll("[data-i18n]");for(const e of t){const t=e.getAttribute("data-i18n"),n=void 0===this.langText[t]?"":this.langText[t];setElementText(e,n)}t=document.querySelectorAll("[data-i18n-attr]");for(const e of t){const t=e.getAttribute("data-i18n-attr").split(",").map(function(t){return t.trim()});for(let n=0,i=t.length;n<i;n++){const i=t[n],l=e.getAttribute(i);null!==l&&e.setAttribute(i,this.langText[l]?this.langText[l]:l)}}t=document.querySelectorAll("a[data-i18n-href]");for(const e of t){const t=e.getAttribute("href").split("/"),n=e.getAttribute("href");(this.hashRouting?0===n.indexOf("#/"):0===n.indexOf("/"))&&t.length>1&&(t[1]=this.currentLocale,e.href=t.join("/"))}t=document.querySelectorAll("a[data-i18n-locales]");for(const e of t){const t=e.getAttribute("data-i18n-locales").split(",").map(t=>t.trim());let n=this.currentLocale;-1===t.indexOf(n)&&(n=-1!==t.indexOf(this.defaultLocale)?this.defaultLocale:t[0]);const i=new RegExp("\\[locale]","g");e.href=e.href.replace(i,n)}t=document.querySelectorAll("[data-i18n-replace-text]");for(const e of t){let t=e.innerHTML;for(const e in this.langText)if(this.langText.hasOwnProperty(e)){let n="[[i18n "+e+"]]";if(-1!==t.indexOf(n)){n="\\[\\[i18n "+e+"]]";const i=new RegExp(n,"g"),l=this.langText[e]?this.langText[e]:e;t=t.replace(i,l)}}e.innerHTML=t}if((t=document.querySelectorAll("[data-i18n-nav-lang]")).length>0){const e=this.hashRouting?null:document.querySelector("url-router").handlePushStateClick;for(const n of t){const t=n.getAttribute("data-i18n-nav-lang");this.hashRouting?n.href=window.location.hash.replace("#/"+this.currentLocale+"/","#/"+t+"/"):(n.href=window.location.pathname.replace("/"+this.currentLocale+"/","/"+t+"/"),n.addEventListener("click",e))}}t=document.querySelectorAll("[data-i18n-nav-selected]");for(const e of t)e.textContent=this.currentLocale;t=document.querySelectorAll('nav[is="spa-links"]');for(const e of t)"function"==typeof e.updateLinks&&e.updateLinks()}}window.customElements.define("i18n-service",I18nService);