import{WebComponentService}from"./WebComponentService.min.js";import{showErrorAlert}from"./utils.min.js";function isNumeric(e){return!isNaN(e)&&isFinite(e)&&!(e.length>1&&"0"===e.substring(0,1))}function excelValue(e){if(""===e)return null;if(isNumeric(e))return parseFloat(e);{const t=new Date(e);if(!isNaN(t.getTime())&&t.getYear()>0&&(e.includes("-")||e.includes(",")||e.includes("/")))return t}return e}function downloadExcelJS(e){if(void 0!==window.ExcelJS)return void e();const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js",t.onload=e,document.querySelector("head").appendChild(t)}function hasInvalidFileNameChars(e){const t=['"',"<",">","|",":","*","?","\\","/"];for(const o of t)if(e.includes(o))return!0;for(let t=0;t<32;t++)if(e.includes(String.fromCharCode(t)))return!0;return!1}function exportTable(e){const t="data-running-export";null===e.target.getAttribute(t)&&(e.target.setAttribute(t,""),"BUTTON"===e.target.nodeName&&(e.target.disabled=!0),downloadExcelJS((()=>{const o=e.target.getAttribute("data-export-excel-selector");let n=e.target.getAttribute("data-export-file-name");if(n&&(n.length<=5||!n.endsWith(".xlsx")||hasInvalidFileNameChars(n)))return void showErrorAlert("Attribute [data-export-file-name] must be a valid name with file type [*.xlsx]");n=n||"Report.xlsx";let r=e.target.getAttribute("data-worksheet-name");r=r||"Report";const l=null!==e.target.getAttribute("data-export-all"),a=document.querySelector(o),i=[],s=[];let c=[],d=a.tHead.rows[0];for(let e=0,t=d.cells.length;e<t;e++){const t=d.cells[e].textContent;c.push(t);const o=t.length,n=parseInt(Math.max(1.2*o,o+4));s.push(n)}i.push(c);const u=a.tBodies[0].rows;for(let e=0,t=u.length;e<t;e++)if(d=u[e],l||"none"!==d.style.display){c=[];for(let e=0,t=d.cells.length;e<t;e++){const t=d.cells[e];let o=t.getAttribute("data-value");null===o&&(o=t.textContent);let n=o.length;o=excelValue(o),o instanceof Date?n=12:"number"==typeof o&&(n=o.toString().length+2),s[e]=Math.max(s[e],n),c.push(o)}i.push(c)}const m=new ExcelJS.Workbook,f=m.addWorksheet(r);for(const e of i)f.addRow(e);const p=f.getRow(1);p.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}},p.font={bold:!0};for(let e=0;e<s.length;e++)f.getColumn(e+1).width=Math.min(50,s[e]);f.autoFilter={from:{row:1,column:1},to:{row:i.length,column:s.length}},f.views=[{state:"frozen",ySplit:1}],m.xlsx.writeBuffer().then((o=>{const r=new Blob([o],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});if(void 0!==navigator.msSaveBlob)navigator.msSaveBlob(r,n);else{const e=document.createElement("a"),t=URL.createObjectURL(r);e.setAttribute("href",t),e.setAttribute("download",n),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}e.target.removeAttribute(t),"BUTTON"===e.target.nodeName&&(e.target.disabled=!1)}))})))}window.customElements.define("export-to-excel-service",class extends WebComponentService{onLoad(){const e=document.querySelectorAll("[data-export-excel-selector]");let t=!1;if(e.length>0){let e=document.querySelector("a");null===e&&(e=document.createElement("a")),t=void 0!==navigator.msSaveBlob||void 0!==e.download}for(const o of e)t?o.addEventListener("click",exportTable):o.style.display="none"}});