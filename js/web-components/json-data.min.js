// @link https://www.dataformsjs.com
// @version 4.8.0
// @author Conrad Sollitt (https://conradsollitt.com)
// @license MIT
import{Format}from"./utils-format.min.js";import{buildUrl,setElementText,getBindValue,bindAttrTmpl,componentsAreDefined,polyfillCustomElements,usingWebComponentsPolyfill}from"./utils.min.js";const format=new Format,appEvents={contentReady:"app:contentReady",error:"app:error"},shadowTmpl=document.createElement("template");shadowTmpl.innerHTML="\n    <style>\n        :host { display: block; }\n        :host([hidden]) { display: none; }\n    </style>\n    <slot></slot>\n";const dataCache=[];function saveDataToCache(t,e,s){for(const a of dataCache)if(a.url===t)return a.params=JSON.stringify(e),void(a.data=s);dataCache.push({url:t,params:JSON.stringify(e),data:s})}function getDataFromCache(t,e){for(const s of dataCache)if(s.url===t){if(e===s.params||null===e&&"null"===s.params)return s.data;break}return null}class JsonData extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this.state={isLoading:!1,hasError:!1,isLoaded:!1,errorMessage:null},this.elements={isLoading:this.querySelector("is-loading"),hasError:this.querySelector("has-error"),isLoaded:this.querySelector("is-loaded")}}static get observedAttributes(){return["url","url-params"]}attributeChangedCallback(t,e){if(void 0!==this.state)switch(t){case"url":case"url-params":null!==e&&this.fetch()}}connectedCallback(){void 0===this.state||this.state.isLoading||this.state.hasError||this.state.isLoaded||this.fetch()}get url(){return this.getAttribute("url")}get urlParams(){return this.getAttribute("url-params")}get loadOnlyOnce(){return"true"===this.getAttribute("load-only-once")}get isLoading(){return this.state.isLoading}set isLoading(t){this.state.isLoading=!0===t,this.elements.isLoading&&(this.elements.isLoading.style.display=this.state.isLoading?"":"none")}get hasError(){return this.state.hasError}set hasError(t){this.state.hasError=!0===t,this.elements.hasError&&(this.elements.hasError.style.display=this.state.hasError?"":"none")}get isLoaded(){return this.state.isLoaded}set isLoaded(t){this.state.isLoaded=!0===t,this.elements.isLoaded&&(this.elements.isLoaded.style.display=this.state.isLoaded?"":"none")}fetch(){const t=this.url;let e=t;if(null===e||""===e)return this.showError("Error, element <json-data> is missing attribute [url]"),void this.dispatchEvent(new Event(appEvents.contentReady,{bubbles:!0}));let s=this.getAttribute("url-params");if(""!==s||!e.includes(":")){if(this.loadOnlyOnce){const e=getDataFromCache(t,s);if(null!==e)return this._setLoadedState(e),void this.dispatchEvent(new Event(appEvents.contentReady,{bubbles:!0}))}s&&(s=JSON.parse(s),e=buildUrl(e,s)),this.isLoading=!0,this.isLoaded=!1,this.hasError=!1,this.bindData(),fetch(e,{mode:"cors",cache:"no-store",credentials:"same-origin"}).then(t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const s="Error loading data. Server Response Code: "+e+", Response Text: "+t.statusText;return Promise.reject(s)}}).then(t=>t.json()).then(e=>{this.loadOnlyOnce&&saveDataToCache(t,s,e),this._setLoadedState(e)}).catch(t=>{this.showError(t)}).finally(()=>{this.dispatchEvent(new Event(appEvents.contentReady,{bubbles:!0}))})}}showError(t){this.isLoading=!1,this.isLoaded=!1,this.hasError=!0,this.state.errorMessage=t,this.dispatchEvent(new CustomEvent(appEvents.error,{bubbles:!0,detail:t})),this.bindData(),console.error(t)}_setLoadedState(t){this.isLoading=!1,this.isLoaded=!0,this.hasError=!1,this.state.errorMessage=null,Object.assign(this.state,t),"boolean"==typeof t.hasError&&(this.hasError=t.hasError),this.bindData()}async bindData(){await componentsAreDefined(this,"[data-bind]");let t=this.querySelectorAll("[data-bind]");for(const e of t){const t=e.getAttribute("data-bind");let s=""===t?this.state:getBindValue(this.state,t);const a=e.getAttribute("data-format");if(null!==a)if("function"==typeof Format[a])s=Format[a](s);else if("function"==typeof window[a])try{s=window[a](s)}catch(t){console.error(t),s="Error: "+t.message}else s="Error: Unknown format ["+a+"]";setElementText(e,s)}t=this.querySelectorAll("[data-bind-attr]");for(const e of t)bindAttrTmpl(e,"data-bind-attr",this.state);t=this.querySelectorAll("[data-show]");for(const e of t)if(this.state.isLoading)e.style.display="none";else{const t=e.getAttribute("data-show");try{const s=new Function("state","format","with(state){return "+t+"}")(this.state,format);e.style.display=!0===s?"":"none"}catch(t){e.style.display="",console.error("Error evaluating JavaScript expression from [data-show] attribute."),console.error(t)}}polyfillCustomElements()}}window.customElements.define("json-data",JsonData),window.customElements.define("is-loading",class extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.isLoading||(this.style.display="none")}}),window.customElements.define("has-error",class extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.hasError||(this.style.display="none")}}),window.customElements.define("is-loaded",class extends HTMLElement{constructor(){if(super(),usingWebComponentsPolyfill())return;this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),"JSON-DATA"===this.parentNode.nodeName&&!0===this.parentNode.isLoaded||(this.style.display="none")}});